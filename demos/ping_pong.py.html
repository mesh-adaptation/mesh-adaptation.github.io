<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Methods for interpolating fields between different meshes &#8212; Animate, Movement and Goalie 0.1 documentation</title>
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <script src="../_static/documentation_options.js?v=2709fde1"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Animate, Movement and Goalie 0.1 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Methods for interpolating fields between different meshes</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="methods-for-interpolating-fields-between-different-meshes">
<h1>Methods for interpolating fields between different meshes<a class="headerlink" href="#methods-for-interpolating-fields-between-different-meshes" title="Link to this heading">¶</a></h1>
<p>In this demo, we perform a ‘ping pong test’, which amounts to interpolating a given
source function repeatedly between the two meshes using a particular interpolation
method. The purpose of this experiment is to assess the properties of different
interpolation methods.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">firedrake</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">firedrake.pyplot</span> <span class="kn">import</span> <span class="n">tricontourf</span><span class="p">,</span> <span class="n">triplot</span>

<span class="kn">from</span> <span class="nn">animate</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
<p>Consider two different meshes of the unit square: mesh A, which is laid out
<span class="math notranslate nohighlight">\(20\times25\)</span> with diagonals from top left to bottom right and mesh B, which is
laid out <span class="math notranslate nohighlight">\(20\times20\)</span> with diagonals from bottom left to top right. Note that
mesh A has higher resolution in the vertical direction.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mesh_A</span> <span class="o">=</span> <span class="n">UnitSquareMesh</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Mesh A&quot;</span><span class="p">)</span>
<span class="n">mesh_B</span> <span class="o">=</span> <span class="n">UnitSquareMesh</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Mesh B&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mesh</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">((</span><span class="n">mesh_A</span><span class="p">,</span> <span class="n">mesh_B</span><span class="p">)):</span>
    <span class="n">triplot</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">mesh</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;ping_pong-meshes.jpg&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
</pre></div>
</div>
<figure class="align-center" style="width: 80%">
<img alt="../_images/ping_pong-meshes.jpg" src="../_images/ping_pong-meshes.jpg" />
</figure>
<p>Define the source function</p>
<div class="math notranslate nohighlight">
\[f(x,y) = \sin(\pi x) \sin(\pi y).\]</div>
<p>Let’s plot it as represented in <span class="math notranslate nohighlight">\(\mathbb{P}1\)</span> spaces on mesh A.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">V_A</span> <span class="o">=</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh_A</span><span class="p">,</span> <span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">V_B</span> <span class="o">=</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh_B</span><span class="p">,</span> <span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">SpatialCoordinate</span><span class="p">(</span><span class="n">mesh_A</span><span class="p">)</span>
<span class="n">source</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">V_A</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Source&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">pi</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">pi</span> <span class="o">*</span> <span class="n">y</span><span class="p">))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">tricontourf</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Source function&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;ping_pong-source_function.jpg&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
</pre></div>
</div>
<figure class="align-center" style="width: 80%">
<img alt="../_images/ping_pong-source_function.jpg" src="../_images/ping_pong-source_function.jpg" />
</figure>
<p>To start with, let’s consider the <code class="docutils literal notranslate"><span class="pre">interpolate</span></code> approach, which evaluates the input
field at the locations corresponding to degrees of freedom of the target function
space. We run the experiment for 50 iterations and track three quantities as the
iterations progress: the integral of the field, its global minimum, and its global
maximum.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">niter</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">initial_integral</span> <span class="o">=</span> <span class="n">assemble</span><span class="p">(</span><span class="n">source</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span>
<span class="n">initial_min</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">gather</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
<span class="n">initial_max</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">gather</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">quantities</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;integral&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;interpolate&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">initial_integral</span><span class="p">]},</span>
    <span class="s2">&quot;minimum&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;interpolate&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">initial_min</span><span class="p">]},</span>
    <span class="s2">&quot;maximum&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;interpolate&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">initial_max</span><span class="p">]},</span>
<span class="p">}</span>
<span class="n">f_interp</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">V_A</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">V_B</span><span class="p">)</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">niter</span><span class="p">):</span>
    <span class="n">interpolate</span><span class="p">(</span><span class="n">f_interp</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span>
    <span class="n">interpolate</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">f_interp</span><span class="p">)</span>
    <span class="n">quantities</span><span class="p">[</span><span class="s2">&quot;integral&quot;</span><span class="p">][</span><span class="s2">&quot;interpolate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">assemble</span><span class="p">(</span><span class="n">f_interp</span> <span class="o">*</span> <span class="n">dx</span><span class="p">))</span>
    <span class="n">quantities</span><span class="p">[</span><span class="s2">&quot;minimum&quot;</span><span class="p">][</span><span class="s2">&quot;interpolate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_interp</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">gather</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="n">quantities</span><span class="p">[</span><span class="s2">&quot;maximum&quot;</span><span class="p">][</span><span class="s2">&quot;interpolate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_interp</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">gather</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="n">f_interp</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;Interpolate&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">subdict</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">quantities</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;interpolate&quot;</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Number of transfers back and forth&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">capitalize</span><span class="p">())</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;ping_pong-quantities_interpolate.jpg&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
</pre></div>
</div>
<figure class="align-center" style="width: 90%">
<img alt="../_images/ping_pong-quantities_interpolate.jpg" src="../_images/ping_pong-quantities_interpolate.jpg" />
</figure>
<p>The first plot shows the integral of the field (i.e., the ‘mass’) as the interpolation
iterations progress. Note that the mass drops steeply, before levelling out after
around 50 iterations. Minimum values are perfectly maintained for this example,
staying at zero for all iterations. Maximum values, however, decrease for several
iterations before levelling out after around 30 iterations. The reason minima are
attained but not maxima is that global minimum values are attained at the boundaries
for this example, wheras the global maximum is attained at the centre of the domain.</p>
<p>In this example, we observe two general properties of the point interpolation method:</p>
<ol class="arabic simple">
<li><p>It is not conservative.</p></li>
<li><p>It does not introduce new extrema.</p></li>
</ol>
<p>To elaborate on the second point, whilst the maximum value does decrease, new maxima
are not introduced. Similarly, no new minima are introduced.</p>
<p>Next, we move on to the <code class="docutils literal notranslate"><span class="pre">project</span></code> approach, which uses the concept of a ‘supermesh’
to set up a conservative projection operator. The clue is in the name: we expect this
approach to conserve ‘mass’, i.e., the integral of the field. In fact, the approach
is designed to satisfy this property. Let <span class="math notranslate nohighlight">\(f\in V_A\)</span> denote the source field.
Then the projection operator, <span class="math notranslate nohighlight">\(\Pi\)</span>, is chosen such that</p>
<div class="math notranslate nohighlight">
\[\int_\Omega f\;\mathrm{d}x = \int_\Omega \Pi(f)\;\mathrm{d}x.\]</div>
<p>This is achieved by solving the equation</p>
<div class="math notranslate nohighlight">
\[\underline{\mathbf{M}_B} \boldsymbol{\pi} = \underline{\mathbf{M}_{BA}} \mathbf{f},\]</div>
<p>for <span class="math notranslate nohighlight">\(\boldsymbol{\pi}\)</span> - the vector of data underlying <span class="math notranslate nohighlight">\(\Pi(f)\)</span> - where
<span class="math notranslate nohighlight">\(\mathbf{f}\)</span> is the vector of data underlying <span class="math notranslate nohighlight">\(f\)</span>,
<span class="math notranslate nohighlight">\(\underline{\mathbf{M}_B}\)</span> is the mass matrix for the target space, <span class="math notranslate nohighlight">\(V_B\)</span>,
and <span class="math notranslate nohighlight">\(\underline{\mathbf{M}_{BA}}\)</span> is the mixed mass matrix mapping from the
source space <span class="math notranslate nohighlight">\(V_A\)</span> to the target space.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">quantities</span><span class="p">[</span><span class="s2">&quot;integral&quot;</span><span class="p">][</span><span class="s2">&quot;project&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">initial_integral</span><span class="p">]</span>
<span class="n">quantities</span><span class="p">[</span><span class="s2">&quot;minimum&quot;</span><span class="p">][</span><span class="s2">&quot;project&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">initial_min</span><span class="p">]</span>
<span class="n">quantities</span><span class="p">[</span><span class="s2">&quot;maximum&quot;</span><span class="p">][</span><span class="s2">&quot;project&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">initial_max</span><span class="p">]</span>
<span class="n">f_proj</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">V_A</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">niter</span><span class="p">):</span>
    <span class="n">project</span><span class="p">(</span><span class="n">f_proj</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span>
    <span class="n">project</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">f_proj</span><span class="p">)</span>
    <span class="n">quantities</span><span class="p">[</span><span class="s2">&quot;integral&quot;</span><span class="p">][</span><span class="s2">&quot;project&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">assemble</span><span class="p">(</span><span class="n">f_proj</span> <span class="o">*</span> <span class="n">dx</span><span class="p">))</span>
    <span class="n">quantities</span><span class="p">[</span><span class="s2">&quot;minimum&quot;</span><span class="p">][</span><span class="s2">&quot;project&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_proj</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">gather</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="n">quantities</span><span class="p">[</span><span class="s2">&quot;maximum&quot;</span><span class="p">][</span><span class="s2">&quot;project&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_proj</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">gather</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="n">f_proj</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;Project&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">subdict</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">quantities</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;interpolate&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Interpolate&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Project&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Number of transfers back and forth&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">capitalize</span><span class="p">())</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;ping_pong-quantities_project.jpg&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
</pre></div>
</div>
<figure class="align-center" style="width: 90%">
<img alt="../_images/ping_pong-quantities_project.jpg" src="../_images/ping_pong-quantities_project.jpg" />
</figure>
<p>The first subfigure shows that mass is indeed conserved by the <code class="docutils literal notranslate"><span class="pre">project</span></code> approach,
unlike the <code class="docutils literal notranslate"><span class="pre">interpolate</span></code> approach. However, contrary to the <code class="docutils literal notranslate"><span class="pre">interpolate</span></code> approach
not introducing new extrema, the <code class="docutils literal notranslate"><span class="pre">project</span></code> approach can be seen to introduce new
minimum values. No new maximum values are introduced, although the maximum values do
decrease slightly. Extrema are not attained because the conservative projection
approach used here is known to be diffusive. The fact that new minima are introduced
is again due to those values being on the boundary.</p>
<p>To summarise, the <code class="docutils literal notranslate"><span class="pre">project</span></code> approach:</p>
<ol class="arabic simple">
<li><p>It is conservative.</p></li>
<li><p>It may introduce new extrema.</p></li>
</ol>
<p>Note that neither of the approaches considered thus far provide an interpolation
method that is both conservative and does not introduce new extrema. In the case of
<span class="math notranslate nohighlight">\(\mathbb P1\)</span> fields specifically, it is possible to achieve this using ‘mass
lumping’. Recall the linear system above. Lumping amounts to replacing the mass matrix
<span class="math notranslate nohighlight">\(\underline{\mathbf{M}_B}\)</span> with a diagonal matrix, whose entries correspond to
the sums over the corresponding mass matrix rows. (See <span id="id1">[<a class="reference internal" href="#id3" title="Patrick E Farrell, Matthew D Piggott, Christopher C Pain, Gerard J Gorman, and Cian R Wilson. Conservative interpolation between unstructured meshes via supermesh construction. Computer methods in applied mechanics and engineering, 198(33-36):2632–2642, 2009.">FPP+09</a>]</span> for details.)</p>
<p>The resulting bounded projection operator can be used in Animate by passing
<code class="docutils literal notranslate"><span class="pre">bounded=True</span></code> to the <code class="docutils literal notranslate"><span class="pre">project</span></code> function.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">quantities</span><span class="p">[</span><span class="s2">&quot;integral&quot;</span><span class="p">][</span><span class="s2">&quot;bounded&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">initial_integral</span><span class="p">]</span>
<span class="n">quantities</span><span class="p">[</span><span class="s2">&quot;minimum&quot;</span><span class="p">][</span><span class="s2">&quot;bounded&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">initial_min</span><span class="p">]</span>
<span class="n">quantities</span><span class="p">[</span><span class="s2">&quot;maximum&quot;</span><span class="p">][</span><span class="s2">&quot;bounded&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">initial_max</span><span class="p">]</span>
<span class="n">f_bounded</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">V_A</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">niter</span><span class="p">):</span>
    <span class="n">project</span><span class="p">(</span><span class="n">f_bounded</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">bounded</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">project</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">f_bounded</span><span class="p">,</span> <span class="n">bounded</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">quantities</span><span class="p">[</span><span class="s2">&quot;integral&quot;</span><span class="p">][</span><span class="s2">&quot;bounded&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">assemble</span><span class="p">(</span><span class="n">f_bounded</span> <span class="o">*</span> <span class="n">dx</span><span class="p">))</span>
    <span class="n">quantities</span><span class="p">[</span><span class="s2">&quot;minimum&quot;</span><span class="p">][</span><span class="s2">&quot;bounded&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_bounded</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">gather</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="n">quantities</span><span class="p">[</span><span class="s2">&quot;maximum&quot;</span><span class="p">][</span><span class="s2">&quot;bounded&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_bounded</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">gather</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="n">f_bounded</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;Bounded project&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">subdict</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">quantities</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;interpolate&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Interpolate&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Project&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;bounded&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Bounded project&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Number of transfers back and forth&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">capitalize</span><span class="p">())</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;ping_pong-quantities_bounded.jpg&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
</pre></div>
</div>
<figure class="align-center" style="width: 90%">
<img alt="../_images/ping_pong-quantities_bounded.jpg" src="../_images/ping_pong-quantities_bounded.jpg" />
</figure>
<p>To check that the interpolants still resemble the source function after 50 iterations,
we plot the final fields alongside it.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">]</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&lt;0.0&quot;</span><span class="p">,</span> <span class="s2">&quot;0.0&quot;</span><span class="p">,</span> <span class="s2">&quot;0.2&quot;</span><span class="p">,</span> <span class="s2">&quot;0.4&quot;</span><span class="p">,</span> <span class="s2">&quot;0.6&quot;</span><span class="p">,</span> <span class="s2">&quot;0.8&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span> <span class="s2">&quot;&gt;1.0&quot;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">f_interp</span><span class="p">,</span> <span class="n">f_proj</span><span class="p">,</span> <span class="n">f_bounded</span><span class="p">)):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">tricontourf</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">levels</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;ping_pong-final.jpg&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
</pre></div>
</div>
<figure class="align-center" style="width: 80%">
<img alt="../_images/ping_pong-final.jpg" src="../_images/ping_pong-final.jpg" />
</figure>
<p>Whilst the first two approaches clearly resemble the input field, the bounded version
gives a much poorer representation. This is because it introduces even more numerical
diffusion than the standard conservative projection approach. As such, we find that,
whilst the bounded conservative projection allows for an interpolation operator with
attractive properties, we shouldn’t expect it to give smaller errors. To demonstrate
this, we print the <span class="math notranslate nohighlight">\(L^2\)</span> errors for each method.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Interpolate:     </span><span class="si">{</span><span class="n">errornorm</span><span class="p">(</span><span class="n">source</span><span class="p">,</span><span class="w"> </span><span class="n">f_interp</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Project:         </span><span class="si">{</span><span class="n">errornorm</span><span class="p">(</span><span class="n">source</span><span class="p">,</span><span class="w"> </span><span class="n">f_proj</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bounded project: </span><span class="si">{</span><span class="n">errornorm</span><span class="p">(</span><span class="n">source</span><span class="p">,</span><span class="w"> </span><span class="n">f_bounded</span><span class="p">)</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Interpolate:     1.7144e-02</span>
<span class="go">Project:         2.5693e-03</span>
<span class="go">Bounded project: 2.3513e-01</span>
</pre></div>
</div>
<p>This demo can also be accessed as a <a class="reference external" href="ping_pong.py">Python script</a>.</p>
<p class="rubric">References</p>
<div class="docutils container" id="id2">
<div role="list" class="citation-list">
<div class="citation" id="id3" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">FPP+09</a><span class="fn-bracket">]</span></span>
<p>Patrick E Farrell, Matthew D Piggott, Christopher C Pain, Gerard J Gorman, and Cian R Wilson. Conservative interpolation between unstructured meshes via supermesh construction. <em>Computer methods in applied mechanics and engineering</em>, 198(33-36):2632–2642, 2009.</p>
</div>
</div>
</div>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/demos/ping_pong.py.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Animate, Movement and Goalie 0.1 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Methods for interpolating fields between different meshes</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2021-2024, Joseph G. Wallwork et al..
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>