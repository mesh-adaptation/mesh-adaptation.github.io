<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Goal-oriented mesh adaptation for a 2D steady-state problem &#8212; Pyroteus 0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/nature.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Hessian-based mesh adaptation for a 2D steady-state problem" href="point_discharge2d-hessian.py.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="point_discharge2d-hessian.py.html" title="Hessian-based mesh adaptation for a 2D steady-state problem"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Pyroteus 0.1 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Goal-oriented mesh adaptation for a 2D steady-state problem</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="goal-oriented-mesh-adaptation-for-a-2d-steady-state-problem">
<h1>Goal-oriented mesh adaptation for a 2D steady-state problem<a class="headerlink" href="#goal-oriented-mesh-adaptation-for-a-2d-steady-state-problem" title="Permalink to this heading">¶</a></h1>
<p>In the <a class="reference external" href="./point_discharge2d-hessian.py.html">previous demo</a>, we applied
Hessian-based mesh adaptation to the “point discharge with diffusion” steady-state 2D
test case. Here, we combine the goal-oriented error estimation approach from
<a class="reference external" href="./point_discharge2d.py.html">another previous demo</a> to provide the first
exposition of goal-oriented mesh adaptation in these demos.</p>
<p>We copy over the setup as before. The only difference is that we import from
<cite>pyroteus_adjoint</cite> rather than <cite>pyroteus</cite>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">firedrake</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">firedrake.meshadapt</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pyroteus_adjoint</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.colors</span> <span class="k">as</span> <span class="nn">mcolors</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">ticker</span>


<span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">get_function_spaces</span><span class="p">(</span><span class="n">mesh</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)}</span>


<span class="k">def</span> <span class="nf">source</span><span class="p">(</span><span class="n">mesh</span><span class="p">):</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">SpatialCoordinate</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
    <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mf">0.05606388</span>
    <span class="k">return</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_form</span><span class="p">(</span><span class="n">mesh_seq</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">form</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">sols</span><span class="p">):</span>
        <span class="n">c</span><span class="p">,</span> <span class="n">c_</span> <span class="o">=</span> <span class="n">sols</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span>
        <span class="n">function_space</span> <span class="o">=</span> <span class="n">mesh_seq</span><span class="o">.</span><span class="n">function_spaces</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="n">as_vector</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">CellSize</span><span class="p">(</span><span class="n">mesh_seq</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">source</span><span class="p">(</span><span class="n">mesh_seq</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>

        <span class="c1"># SUPG stabilisation parameter</span>
        <span class="n">unorm</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">u</span><span class="p">))</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">h</span> <span class="o">/</span> <span class="n">unorm</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">min_value</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">unorm</span> <span class="o">*</span> <span class="n">h</span> <span class="o">/</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">D</span><span class="p">))</span>

        <span class="c1"># Setup variational problem</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">TestFunction</span><span class="p">(</span><span class="n">function_space</span><span class="p">)</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">psi</span> <span class="o">+</span> <span class="n">tau</span> <span class="o">*</span> <span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">grad</span><span class="p">(</span><span class="n">psi</span><span class="p">))</span>
        <span class="n">F</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">grad</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="o">*</span> <span class="n">psi</span> <span class="o">*</span> <span class="n">dx</span>
            <span class="o">+</span> <span class="n">inner</span><span class="p">(</span><span class="n">D</span> <span class="o">*</span> <span class="n">grad</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">grad</span><span class="p">(</span><span class="n">psi</span><span class="p">))</span> <span class="o">*</span> <span class="n">dx</span>
            <span class="o">-</span> <span class="n">S</span> <span class="o">*</span> <span class="n">psi</span> <span class="o">*</span> <span class="n">dx</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="n">F</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">form</span>


<span class="k">def</span> <span class="nf">get_bcs</span><span class="p">(</span><span class="n">mesh_seq</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">bcs</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
        <span class="n">function_space</span> <span class="o">=</span> <span class="n">mesh_seq</span><span class="o">.</span><span class="n">function_spaces</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">DirichletBC</span><span class="p">(</span><span class="n">function_space</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">bcs</span>


<span class="k">def</span> <span class="nf">get_solver</span><span class="p">(</span><span class="n">mesh_seq</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">solver</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">ic</span><span class="p">):</span>
        <span class="n">function_space</span> <span class="o">=</span> <span class="n">mesh_seq</span><span class="o">.</span><span class="n">function_spaces</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>

        <span class="c1"># Ensure dependence on the initial condition</span>
        <span class="n">c_</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">function_space</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;c_old&quot;</span><span class="p">)</span>
        <span class="n">c_</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">ic</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">])</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">function_space</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">c_</span><span class="p">)</span>

        <span class="c1"># Setup variational problem</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">mesh_seq</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">c_</span><span class="p">)})[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span>
        <span class="n">bc</span> <span class="o">=</span> <span class="n">mesh_seq</span><span class="o">.</span><span class="n">bcs</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

        <span class="n">solve</span><span class="p">(</span><span class="n">F</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bc</span><span class="p">,</span> <span class="n">ad_block_tag</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">solver</span>


<span class="k">def</span> <span class="nf">get_qoi</span><span class="p">(</span><span class="n">mesh_seq</span><span class="p">,</span> <span class="n">sol</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">qoi</span><span class="p">():</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">]</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">SpatialCoordinate</span><span class="p">(</span><span class="n">mesh_seq</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="n">xr</span><span class="p">,</span> <span class="n">yr</span><span class="p">,</span> <span class="n">rr</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">0.5</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">conditional</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">xr</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">yr</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="n">rr</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">kernel</span> <span class="o">*</span> <span class="n">c</span> <span class="o">*</span> <span class="n">dx</span>

    <span class="k">return</span> <span class="n">qoi</span>
</pre></div>
</div>
<p>Since we want to do goal-oriented mesh adaptation, we use a
<code class="xref py py-class docutils literal notranslate"><span class="pre">GoalOrientedMeshSeq</span></code>. In addition to the element count convergence criterion,
we add another relative tolerance condition for the change in QoI value between
iterations.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">params</span> <span class="o">=</span> <span class="n">GoalOrientedMetricParameters</span><span class="p">({</span><span class="s2">&quot;element_rtol&quot;</span><span class="p">:</span> <span class="mf">0.005</span><span class="p">,</span> <span class="s2">&quot;qoi_rtol&quot;</span><span class="p">:</span> <span class="mf">0.005</span><span class="p">})</span>

<span class="n">mesh</span> <span class="o">=</span> <span class="n">RectangleMesh</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">time_partition</span> <span class="o">=</span> <span class="n">TimeInstant</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
<span class="n">mesh_seq</span> <span class="o">=</span> <span class="n">GoalOrientedMeshSeq</span><span class="p">(</span>
    <span class="n">time_partition</span><span class="p">,</span>
    <span class="n">mesh</span><span class="p">,</span>
    <span class="n">get_function_spaces</span><span class="o">=</span><span class="n">get_function_spaces</span><span class="p">,</span>
    <span class="n">get_form</span><span class="o">=</span><span class="n">get_form</span><span class="p">,</span>
    <span class="n">get_bcs</span><span class="o">=</span><span class="n">get_bcs</span><span class="p">,</span>
    <span class="n">get_solver</span><span class="o">=</span><span class="n">get_solver</span><span class="p">,</span>
    <span class="n">get_qoi</span><span class="o">=</span><span class="n">get_qoi</span><span class="p">,</span>
    <span class="n">qoi_type</span><span class="o">=</span><span class="s2">&quot;steady&quot;</span><span class="p">,</span>
    <span class="n">parameters</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Let’s solve the adjoint problem on the initial mesh so that we can see what the
corresponding solution looks like.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">solutions</span> <span class="o">=</span> <span class="n">mesh_seq</span><span class="o">.</span><span class="n">solve_adjoint</span><span class="p">()</span>
<span class="n">plot_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;levels&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s2">&quot;figsize&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="s2">&quot;cmap&quot;</span><span class="p">:</span> <span class="s2">&quot;coolwarm&quot;</span><span class="p">}</span>
<span class="n">interior_kw</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">}</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">tcs</span> <span class="o">=</span> <span class="n">plot_snapshots</span><span class="p">(</span>
    <span class="n">solutions</span><span class="p">,</span>
    <span class="n">time_partition</span><span class="p">,</span>
    <span class="s2">&quot;c&quot;</span><span class="p">,</span>
    <span class="s2">&quot;adjoint&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">tcs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Adjoint solution on initial mesh&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;point_discharge2d-adjoint_init.jpg&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<figure class="align-center" style="width: 100%">
<img alt="../_images/point_discharge2d-mesh0.jpg" src="../_images/point_discharge2d-mesh0.jpg" />
</figure>
<figure class="align-center" style="width: 80%">
<img alt="../_images/point_discharge2d-forward_init.jpg" src="../_images/point_discharge2d-forward_init.jpg" />
</figure>
<figure class="align-center" style="width: 80%">
<img alt="../_images/point_discharge2d-adjoint_init.jpg" src="../_images/point_discharge2d-adjoint_init.jpg" />
</figure>
<p>The adaptor takes a different form in this case, depending on adjoint solution data
as well as forward solution data. For simplicity, we begin by using Pyroteus’ inbuilt
isotropic metric function.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">adaptor</span><span class="p">(</span><span class="n">mesh_seq</span><span class="p">,</span> <span class="n">solutions</span><span class="p">,</span> <span class="n">indicators</span><span class="p">):</span>
    <span class="c1"># Deduce an isotropic metric from the error indicator field</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">isotropic_metric</span><span class="p">(</span><span class="n">indicators</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Ramp the target metric complexity from 400 to 1000 over the first few iterations</span>
    <span class="n">base</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">iteration</span> <span class="o">=</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">mesh_seq</span><span class="o">.</span><span class="n">fp_iteration</span>
    <span class="n">mp</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;dm_plex_metric_target_complexity&quot;</span><span class="p">:</span> <span class="n">ramp_complexity</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">iteration</span><span class="p">)}</span>
    <span class="n">metric</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span>

    <span class="c1"># Normalise the metric according to the target complexity and then adapt the mesh</span>
    <span class="n">metric</span><span class="o">.</span><span class="n">normalise</span><span class="p">()</span>
    <span class="n">complexity</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">complexity</span><span class="p">()</span>
    <span class="n">mesh_seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">adapt</span><span class="p">(</span><span class="n">mesh_seq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">metric</span><span class="p">)</span>
    <span class="n">num_dofs</span> <span class="o">=</span> <span class="n">mesh_seq</span><span class="o">.</span><span class="n">vertex_counts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">num_elem</span> <span class="o">=</span> <span class="n">mesh_seq</span><span class="o">.</span><span class="n">element_counts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pyrint</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">iteration</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">:</span><span class="s2">2d</span><span class="si">}</span><span class="s2">, complexity: </span><span class="si">{</span><span class="n">complexity</span><span class="si">:</span><span class="s2">4.0f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;, dofs: </span><span class="si">{</span><span class="n">num_dofs</span><span class="si">:</span><span class="s2">4d</span><span class="si">}</span><span class="s2">, elements: </span><span class="si">{</span><span class="n">num_elem</span><span class="si">:</span><span class="s2">4d</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Plot each intermediate adapted mesh</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">mesh_seq</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">interior_kw</span><span class="o">=</span><span class="n">interior_kw</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mesh at iteration </span><span class="si">{</span><span class="n">iteration</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;point_discharge2d-iso_go_mesh</span><span class="si">{</span><span class="n">iteration</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">.jpg&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Plot error indicator on intermediate meshes</span>
    <span class="n">plot_kwargs</span><span class="p">[</span><span class="s2">&quot;norm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">()</span>
    <span class="n">plot_kwargs</span><span class="p">[</span><span class="s2">&quot;locator&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">LogLocator</span><span class="p">()</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">tcs</span> <span class="o">=</span> <span class="n">plot_indicator_snapshots</span><span class="p">(</span>
        <span class="n">indicators</span><span class="p">,</span> <span class="n">time_partition</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_kwargs</span>
    <span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Indicator at iteration </span><span class="si">{</span><span class="n">mesh_seq</span><span class="o">.</span><span class="n">fp_iteration</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">tcs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;point_discharge2d-iso_go_indicator</span><span class="si">{</span><span class="n">mesh_seq</span><span class="o">.</span><span class="n">fp_iteration</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">.jpg&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Check whether the target complexity has been (approximately) reached. If not,</span>
    <span class="c1"># return ``True`` to indicate that convergence checks should be skipped until the</span>
    <span class="c1"># next fixed point iteration.</span>
    <span class="n">continue_unconditionally</span> <span class="o">=</span> <span class="n">complexity</span> <span class="o">&lt;</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="n">target</span>
    <span class="k">return</span> <span class="n">continue_unconditionally</span>
</pre></div>
</div>
<p>With the adaptor function defined, we can call the fixed point iteration method. Note
that, in addition to solving the forward problem, this version of the fixed point
iteration method solves the adjoint problem, as well as solving the forward problem
again on a globally uniformly refined mesh. The latter is particularly expensive, so
we should expect the computation to take more time.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">solutions</span> <span class="o">=</span> <span class="n">mesh_seq</span><span class="o">.</span><span class="n">fixed_point_iteration</span><span class="p">(</span><span class="n">adaptor</span><span class="p">)</span>
<span class="n">qoi_iso</span> <span class="o">=</span> <span class="n">mesh_seq</span><span class="o">.</span><span class="n">qoi_values</span>
<span class="n">dofs_iso</span> <span class="o">=</span> <span class="n">mesh_seq</span><span class="o">.</span><span class="n">vertex_counts</span>
</pre></div>
</div>
<p>This time, we find that the fixed point iteration converges in five iterations.
Convergence is reached because the relative change in QoI is found to be smaller than
the default tolerance.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go"> 1, complexity:  371, dofs:  561, elements: 1000</span>
<span class="go"> 2, complexity:  588, dofs:  526, elements:  988</span>
<span class="go"> 3, complexity:  785, dofs:  729, elements: 1392</span>
<span class="go"> 4, complexity:  982, dofs:  916, elements: 1754</span>
<span class="go">Terminated due to QoI convergence after 5 iterations</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">mesh_seq</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">interior_kw</span><span class="o">=</span><span class="n">interior_kw</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Adapted mesh&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;point_discharge2d-iso_go_mesh.jpg&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">plot_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;levels&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s2">&quot;figsize&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="s2">&quot;cmap&quot;</span><span class="p">:</span> <span class="s2">&quot;coolwarm&quot;</span><span class="p">}</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">tcs</span> <span class="o">=</span> <span class="n">plot_snapshots</span><span class="p">(</span>
    <span class="n">solutions</span><span class="p">,</span>
    <span class="n">time_partition</span><span class="p">,</span>
    <span class="s2">&quot;c&quot;</span><span class="p">,</span>
    <span class="s2">&quot;forward&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">tcs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Forward solution on adapted mesh&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;point_discharge2d-forward_iso_go_adapted.jpg&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<figure class="align-center" style="width: 100%">
<img alt="../_images/point_discharge2d-iso_go_mesh.jpg" src="../_images/point_discharge2d-iso_go_mesh.jpg" />
</figure>
<figure class="align-center" style="width: 80%">
<img alt="../_images/point_discharge2d-forward_iso_go_adapted.jpg" src="../_images/point_discharge2d-forward_iso_go_adapted.jpg" />
</figure>
<p>Looking at the final adapted mesh, we can make a few observations. Firstly, the mesh
elements are indeed isotropic. Secondly, there is clearly increased resolution
surrounding the point source, as well as the “receiver region” which the QoI integrates
over. There is also a band of increased resolution between these two regions. Finally,
the mesh has low resolution downstream of the receiver region. This is to be expected
because we have an advection-dominated problem, so the QoI value is independent of the
dynamics there.</p>
<p>Pyroteus also provides drivers for <em>anisotropic</em> goal-oriented mesh adaptation. Here,
we consider the <code class="docutils literal notranslate"><span class="pre">anisotropic_dwr_metric</span></code> driver. (See documentation for details.) To
use it, we just need to define a different adaptor function. The same error indicator
is used as for the isotropic approach. In addition, the Hessian of the forward
solution is provided to give anisotropy to the metric.</p>
<p>For this driver, normalisation is handled differently than for <code class="docutils literal notranslate"><span class="pre">isotropic_metric</span></code>,
where the <code class="docutils literal notranslate"><span class="pre">normalise</span></code> method is called after construction. In this case, the metric
is already normalised within the call to <code class="docutils literal notranslate"><span class="pre">anisotropic_dwr_metric</span></code>, so this is not
required.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">adaptor</span><span class="p">(</span><span class="n">mesh_seq</span><span class="p">,</span> <span class="n">solutions</span><span class="p">,</span> <span class="n">indicators</span><span class="p">):</span>
    <span class="n">base</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">iteration</span> <span class="o">=</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">mesh_seq</span><span class="o">.</span><span class="n">fp_iteration</span>

    <span class="c1"># Deduce an anisotropic metric from the error indicator field and the Hessian of the</span>
    <span class="c1"># forward solution</span>
    <span class="n">hessian</span> <span class="o">=</span> <span class="n">recover_hessian</span><span class="p">(</span><span class="n">solutions</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">][</span><span class="s2">&quot;forward&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">anisotropic_metric</span><span class="p">(</span>
        <span class="n">indicators</span><span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">hessian</span><span class="p">,</span>
        <span class="n">target_complexity</span><span class="o">=</span><span class="n">ramp_complexity</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">iteration</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">complexity</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">complexity</span><span class="p">()</span>

    <span class="c1"># Adapt the mesh</span>
    <span class="n">mesh_seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">adapt</span><span class="p">(</span><span class="n">mesh_seq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">metric</span><span class="p">)</span>
    <span class="n">num_dofs</span> <span class="o">=</span> <span class="n">mesh_seq</span><span class="o">.</span><span class="n">vertex_counts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">num_elem</span> <span class="o">=</span> <span class="n">mesh_seq</span><span class="o">.</span><span class="n">element_counts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pyrint</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">iteration</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">:</span><span class="s2">2d</span><span class="si">}</span><span class="s2">, complexity: </span><span class="si">{</span><span class="n">complexity</span><span class="si">:</span><span class="s2">4.0f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;, dofs: </span><span class="si">{</span><span class="n">num_dofs</span><span class="si">:</span><span class="s2">4d</span><span class="si">}</span><span class="s2">, elements: </span><span class="si">{</span><span class="n">num_elem</span><span class="si">:</span><span class="s2">4d</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Plot each intermediate adapted mesh</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">mesh_seq</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">interior_kw</span><span class="o">=</span><span class="n">interior_kw</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mesh at iteration </span><span class="si">{</span><span class="n">iteration</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;point_discharge2d-aniso_go_mesh</span><span class="si">{</span><span class="n">iteration</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">.jpg&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Plot error indicator on intermediate meshes</span>
    <span class="n">plot_kwargs</span><span class="p">[</span><span class="s2">&quot;norm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">()</span>
    <span class="n">plot_kwargs</span><span class="p">[</span><span class="s2">&quot;locator&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">LogLocator</span><span class="p">()</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">tcs</span> <span class="o">=</span> <span class="n">plot_indicator_snapshots</span><span class="p">(</span>
        <span class="n">indicators</span><span class="p">,</span> <span class="n">time_partition</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_kwargs</span>
    <span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Indicator at iteration </span><span class="si">{</span><span class="n">mesh_seq</span><span class="o">.</span><span class="n">fp_iteration</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">tcs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;point_discharge2d-aniso_go_indicator</span><span class="si">{</span><span class="n">mesh_seq</span><span class="o">.</span><span class="n">fp_iteration</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">.jpg&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Check whether the target complexity has been (approximately) reached. If not,</span>
    <span class="c1"># return ``True`` to indicate that convergence checks should be skipped until the</span>
    <span class="c1"># next fixed point iteration.</span>
    <span class="n">continue_unconditionally</span> <span class="o">=</span> <span class="n">complexity</span> <span class="o">&lt;</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="n">target</span>
    <span class="k">return</span> <span class="n">continue_unconditionally</span>
</pre></div>
</div>
<p>To avoid confusion, we redefine the <code class="xref py py-class docutils literal notranslate"><span class="pre">GoalOrientedMeshSeq</span></code> object before using
it.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mesh_seq</span> <span class="o">=</span> <span class="n">GoalOrientedMeshSeq</span><span class="p">(</span>
    <span class="n">time_partition</span><span class="p">,</span>
    <span class="n">mesh</span><span class="p">,</span>
    <span class="n">get_function_spaces</span><span class="o">=</span><span class="n">get_function_spaces</span><span class="p">,</span>
    <span class="n">get_form</span><span class="o">=</span><span class="n">get_form</span><span class="p">,</span>
    <span class="n">get_bcs</span><span class="o">=</span><span class="n">get_bcs</span><span class="p">,</span>
    <span class="n">get_solver</span><span class="o">=</span><span class="n">get_solver</span><span class="p">,</span>
    <span class="n">get_qoi</span><span class="o">=</span><span class="n">get_qoi</span><span class="p">,</span>
    <span class="n">qoi_type</span><span class="o">=</span><span class="s2">&quot;steady&quot;</span><span class="p">,</span>
    <span class="n">parameters</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">solutions</span> <span class="o">=</span> <span class="n">mesh_seq</span><span class="o">.</span><span class="n">fixed_point_iteration</span><span class="p">(</span><span class="n">adaptor</span><span class="p">)</span>
<span class="n">qoi_aniso</span> <span class="o">=</span> <span class="n">mesh_seq</span><span class="o">.</span><span class="n">qoi_values</span>
<span class="n">dofs_aniso</span> <span class="o">=</span> <span class="n">mesh_seq</span><span class="o">.</span><span class="n">vertex_counts</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go"> 1, complexity:  400, dofs:  561, elements: 1000</span>
<span class="go"> 2, complexity:  600, dofs:  590, elements: 1121</span>
<span class="go"> 3, complexity:  800, dofs:  876, elements: 1700</span>
<span class="go"> 4, complexity: 1000, dofs: 1079, elements: 2101</span>
<span class="go">Terminated due to QoI convergence after 5 iterations</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">mesh_seq</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">interior_kw</span><span class="o">=</span><span class="n">interior_kw</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Adapted mesh&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;point_discharge2d-aniso_go_mesh.jpg&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">plot_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;levels&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s2">&quot;figsize&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="s2">&quot;cmap&quot;</span><span class="p">:</span> <span class="s2">&quot;coolwarm&quot;</span><span class="p">}</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">tcs</span> <span class="o">=</span> <span class="n">plot_snapshots</span><span class="p">(</span>
    <span class="n">solutions</span><span class="p">,</span>
    <span class="n">time_partition</span><span class="p">,</span>
    <span class="s2">&quot;c&quot;</span><span class="p">,</span>
    <span class="s2">&quot;forward&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">tcs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Forward solution on adapted mesh&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;point_discharge2d-forward_aniso_go_adapted.jpg&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<figure class="align-center" style="width: 100%">
<img alt="../_images/point_discharge2d-aniso_go_mesh.jpg" src="../_images/point_discharge2d-aniso_go_mesh.jpg" />
</figure>
<figure class="align-center" style="width: 80%">
<img alt="../_images/point_discharge2d-forward_aniso_go_adapted.jpg" src="../_images/point_discharge2d-forward_aniso_go_adapted.jpg" />
</figure>
<p>This time, the elements are clearly anisotropic. This anisotropy is inherited from the
Hessian of the adjoint solution. There is still high resolution at the source and
receiver, as well as coarse resolution downstream.</p>
<p>This demo can also be accessed as a <a class="reference external" href="point_discharge2d-goal_oriented.py">Python script</a>.</p>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="point_discharge2d-hessian.py.html"
                          title="previous chapter">Hessian-based mesh adaptation for a 2D steady-state problem</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/demos/point_discharge2d-goal_oriented.py.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="point_discharge2d-hessian.py.html" title="Hessian-based mesh adaptation for a 2D steady-state problem"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Pyroteus 0.1 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Goal-oriented mesh adaptation for a 2D steady-state problem</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2021-2023, Joseph G. Wallwork et al..
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.0.0.
    </div>
  </body>
</html>