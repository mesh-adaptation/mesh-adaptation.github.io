
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Adjoint of Burgers equation with a time integrated QoI &#8212; Pyroteus 0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/classic.css" />
    
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Object-oriented Burgers equation" href="burgers-oo.py.html" />
    <link rel="prev" title="Adjoint of Burgers equation on two meshes" href="burgers2.py.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="burgers-oo.py.html" title="Object-oriented Burgers equation"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="burgers2.py.html" title="Adjoint of Burgers equation on two meshes"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Pyroteus 0.1 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Adjoint of Burgers equation with a time integrated QoI</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="adjoint-of-burgers-equation-with-a-time-integrated-qoi">
<h1>Adjoint of Burgers equation with a time integrated QoI<a class="headerlink" href="#adjoint-of-burgers-equation-with-a-time-integrated-qoi" title="Permalink to this headline">Â¶</a></h1>
<p>So far, we only considered a quantity of interest
corresponding to a spatial integral at the end time.
For some problems, it is more suitable to have a QoI
which integrates in time as well as space.</p>
<p>Begin by importing from Pyroteus and the first Burgers
demo.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">firedrake</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pyroteus_adjoint</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">burgers</span> <span class="kn">import</span> <span class="n">get_initial_condition</span><span class="p">,</span> <span class="n">get_function_spaces</span><span class="p">,</span> <span class="n">get_form</span>
</pre></div>
</div>
<p>The solver needs to be modified slightly in order to take
account of time dependent QoIs. The Burgers solver
uses backward Euler timestepping. The corresponding
quadrature routine is like the midpoint rule, but takes
the value from the next timestep, rather than the average
between that and the current value. As such, the QoI may
be computed by simply incrementing as follows.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_solver</span><span class="p">(</span><span class="n">mesh_seq</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">solver</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">ic</span><span class="p">):</span>
        <span class="n">function_space</span> <span class="o">=</span> <span class="n">mesh_seq</span><span class="o">.</span><span class="n">function_spaces</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">function_space</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;u&quot;</span><span class="p">)</span>
        <span class="n">solution_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;u&quot;</span><span class="p">:</span> <span class="n">u</span><span class="p">}</span>

        <span class="c1"># Initialise &#39;lagged&#39; solution</span>
        <span class="n">u_</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">function_space</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;u_old&quot;</span><span class="p">)</span>
        <span class="n">u_</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">ic</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">])</span>

        <span class="c1"># Define form</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">mesh_seq</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;u&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">u_</span><span class="p">)})</span>

        <span class="c1"># Time integrate from t_start to t_end</span>
        <span class="n">t_start</span><span class="p">,</span> <span class="n">t_end</span> <span class="o">=</span> <span class="n">mesh_seq</span><span class="o">.</span><span class="n">subintervals</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">mesh_seq</span><span class="o">.</span><span class="n">time_partition</span><span class="o">.</span><span class="n">timesteps</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t_start</span>
        <span class="n">qoi</span> <span class="o">=</span> <span class="n">mesh_seq</span><span class="o">.</span><span class="n">get_qoi</span><span class="p">(</span><span class="n">solution_map</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">t_end</span> <span class="o">-</span> <span class="mf">1.0e-05</span><span class="p">:</span>
            <span class="n">solve</span><span class="p">(</span><span class="n">F</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ad_block_tag</span><span class="o">=</span><span class="s2">&quot;u&quot;</span><span class="p">)</span>
            <span class="n">mesh_seq</span><span class="o">.</span><span class="n">J</span> <span class="o">+=</span> <span class="n">qoi</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">u_</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="n">dt</span>
        <span class="k">return</span> <span class="n">solution_map</span>

    <span class="k">return</span> <span class="n">solver</span>
</pre></div>
</div>
<p>The QoI is effectively just a time-integrated version
of the one previously seen.</p>
<div class="math notranslate nohighlight">
\[J(u) = \int_0^{T_{\mathrm{end}}} \int_0^1
\mathbf u(1,y,t) \cdot \mathbf u(1,y,t)
\;\mathrm dy\;\mathrm dt.\]</div>
<p>Note that in this case we multiply by the timestep.
It is wrapped in a <code class="xref py py-class docutils literal notranslate"><span class="pre">Constant</span></code> to avoid
recompilation if the value is changed.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_qoi</span><span class="p">(</span><span class="n">mesh_seq</span><span class="p">,</span> <span class="n">solutions</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
    <span class="n">dtc</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="n">mesh_seq</span><span class="o">.</span><span class="n">time_partition</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">time_integrated_qoi</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">solutions</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">dtc</span> <span class="o">*</span> <span class="n">inner</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span> <span class="o">*</span> <span class="n">ds</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">time_integrated_qoi</span>
</pre></div>
</div>
<p>We use the same mesh setup as in <a class="reference external" href="./burgers2.py.html">the previous demo</a> and the same time partitioning.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">]</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">meshes</span> <span class="o">=</span> <span class="p">[</span><span class="n">UnitSquareMesh</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">),</span> <span class="n">UnitSquareMesh</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)]</span>
<span class="n">end_time</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">n</span>

<span class="n">num_subintervals</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">time_partition</span> <span class="o">=</span> <span class="n">TimePartition</span><span class="p">(</span>
    <span class="n">end_time</span><span class="p">,</span> <span class="n">num_subintervals</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">timesteps_per_export</span><span class="o">=</span><span class="mi">2</span>
<span class="p">)</span>
<span class="n">mesh_seq</span> <span class="o">=</span> <span class="n">AdjointMeshSeq</span><span class="p">(</span>
    <span class="n">time_partition</span><span class="p">,</span>
    <span class="n">meshes</span><span class="p">,</span>
    <span class="n">get_function_spaces</span><span class="o">=</span><span class="n">get_function_spaces</span><span class="p">,</span>
    <span class="n">get_initial_condition</span><span class="o">=</span><span class="n">get_initial_condition</span><span class="p">,</span>
    <span class="n">get_form</span><span class="o">=</span><span class="n">get_form</span><span class="p">,</span>
    <span class="n">get_solver</span><span class="o">=</span><span class="n">get_solver</span><span class="p">,</span>
    <span class="n">get_qoi</span><span class="o">=</span><span class="n">get_qoi</span><span class="p">,</span>
    <span class="n">qoi_type</span><span class="o">=</span><span class="s2">&quot;time_integrated&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">solutions</span> <span class="o">=</span> <span class="n">mesh_seq</span><span class="o">.</span><span class="n">solve_adjoint</span><span class="p">()</span>
</pre></div>
</div>
<p>Finally, plot snapshots of the adjoint solution.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plot_snapshots</span><span class="p">(</span><span class="n">solutions</span><span class="p">,</span> <span class="n">time_partition</span><span class="p">,</span> <span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="s2">&quot;adjoint&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;burgers-time_integrated.jpg&quot;</span><span class="p">)</span>
</pre></div>
</div>
<figure class="align-center" style="width: 90%">
<img alt="../_images/burgers-time_integrated.jpg" src="../_images/burgers-time_integrated.jpg" />
</figure>
<p>With a time-integrated QoI, the adjoint problem
has a source term at the right hand boundary, rather
than a instantaneous pulse at the terminal time.</p>
<p>In the <a class="reference external" href="./burgers-oo.py.html">next demo</a>, we solve
the Burgers problem one last time, but using an
object-oriented approach.</p>
<p>This demo can also be accessed as a <a class="reference external" href="burgers-time_integrated.py">Python script</a>.</p>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h4>Previous topic</h4>
  <p class="topless"><a href="burgers2.py.html"
                        title="previous chapter">Adjoint of Burgers equation on two meshes</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="burgers-oo.py.html"
                        title="next chapter">Object-oriented Burgers equation</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/demos/burgers-time_integrated.py.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="burgers-oo.py.html" title="Object-oriented Burgers equation"
             >next</a> |</li>
        <li class="right" >
          <a href="burgers2.py.html" title="Adjoint of Burgers equation on two meshes"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Pyroteus 0.1 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Adjoint of Burgers equation with a time integrated QoI</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2021-2022, Joseph G. Wallwork et al..
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.3.2.
    </div>
  </body>
</html>